# Elizabeth 前后端 API 集成计划

# 前端 UI 完整功能测试计划

重要！:使用 chrome-devtools 进行前端 UI 自动化探索和问题修复

前端 UI 的各个功能都测试通过 UI
测试的方式使其测试通过。确保前端功能正确，逻辑正确。并且 UI
反馈和行为也是正确的。只能使用 chrome-devtools
进行前端自动化探索和问题修复，除非十分必要，可以使用 curl
来辅助你。不能使用其它工具。
。但是如果遇到问题，请你上网查询解决办法积极使用各种 MCP
工具来辅助你完成相关任务 数据库是 sqlite,
当遇到问题时你可以直接查看数据库的内容：
/Users/unic/dev/projs/rs/elizabeth/app.db 从而辅助你找到问题所在

并且去除冗余的程序逻辑和 logs. 保持项目代码的 KISS, LISP,
函数化，模块化，可组合性

you you should only use manage_services.sh to manage backend and frontend
services, and you should lookup related log file when you encounter issues.

这里是数据库：/Users/unic/dev/projs/rs/elizabeth/app.db
(位置是正确的，代码中的位置也是正确的.) 这里是 sqlx 的 migration :
/Users/unic/dev/projs/rs/elizabeth/crates/board/migrations (sqlx
代码编写时的数据库在/Users/unic/dev/projs/rs/elizabeth/crates/board/app.db,
但是实际前后端集成测试的数据库位于 /Users/unic/dev/projs/rs/elizabeth/app.db)
关于数据库的删除和重建，请你参考 /Users/unic/dev/projs/rs/elizabeth/justfile
中的

# 🧨 删除并重建数据库（重新执行迁移）

db-reset: _check-env #!/usr/bin/env bash echo "🧨 重置数据库..." if [[ -f
"$DATABASE_FILE" ]]; then
        rm -f "$DATABASE_FILE" echo "🗑️ 已删除旧数据库文件" fi just migrate echo
"✅ 数据库重置完成"

数据库是 sqlite, 当遇到问题时你可以直接查看数据库的内容：
/Users/unic/dev/projs/rs/elizabeth/app.db 从而辅助你找到问题所在

## 1. 房间访问与身份验证测试

### 1.1 房间自动创建与访问

- **步骤**：直接访问 `http://localhost:4001/new-room-test`
- **期望**：自动创建房间并进入，显示完整的房间界面
- **检查点**：
- 顶部栏显示房间占用信息
- 左侧栏显示房间设置
- 中间栏显示消息输入区
- 右侧栏显示文件上传区
- **验证**：检查 localStorage 中是否有 token，token 权限是否为 15（全权限）

### 1.2 SHARE 权限控制测试

- **步骤**：

1. 创建房间
2. 移除 SHARE 权限并保存
3. 记录新的 slug（包含 UUID）
4. 尝试用房间名称直接访问
5. 用新的 slug 访问

- **期望**：
- 移除 SHARE 后，直接访问被拒绝，显示错误提示
- 使用 slug 访问成功
- 分享区域显示新的 slug URL
- **验证**：检查 URL 变化、token 更新、UI 反馈

### 1.3 密码保护房间测试

- **步骤**：

1. 在房间设置中设置密码
2. 保存设置
3. 刷新页面或新标签页访问
4. 输入正确密码
5. 输入错误密码

- **期望**：
- 设置密码后显示密码输入对话框
- 正确密码可以进入
- 错误密码显示错误提示
- **验证**：密码对话框显示、错误提示、成功进入后 token 获取

### 1.4 房间查看次数测试

步骤

1. 在房间设置中配置最大查看次数
2. 保存设置
3. 刷新页面或者新建标签页访问

期望

1. 每次访问都会让房间可被访问次数减少一次
2. 房间可被访问次数==0 时，房间内容清空，房间完全重置

### 1.5 房间过期时间测试

步骤

1. 在房间设置中配置房间过期时间
2. 保存设置
3. 刷新页面或者新建标签页访问

期望

1. 在房间过期时间之前去访问房间，房间内容保持。并且允许用户变更
   (如果有对应权限的话)
2. 超过房间过期时间去访问房间时，房间内容清空，房间完全重置

## 2. 顶部栏功能测试 (TopBar)

### 2.1 消息复制功能

- **步骤**：

1. 发送几条消息
2. 选择消息（点击 checkbox）
3. 点击"复制选中消息"按钮

- **期望**：
- 未选择消息时，按钮禁用或点击后提示"未选择消息"
- 选择消息后，点击按钮复制成功
- 显示 toast 提示"已复制 X 条消息"
- **验证**：剪贴板内容、toast 提示、按钮状态

### 2.2 消息导出下载功能

- **步骤**：

1. 选择多条消息
2. 点击"下载导出选中消息"按钮

- **期望**：
- 触发文件下载
- 文件内容包含选中的消息
- 如果开启元数据，包含用户、时间等信息
- **验证**：下载文件、文件内容格式、元数据选项

### 2.3 删除功能

- **步骤**：

1. 选择消息或文件
2. 点击顶部"删除"按钮

- **期望**：
- 显示确认对话框（如果有）
- 删除成功
- 列表更新
- 显示成功 toast
- **验证**：确认流程、删除成功、UI 更新

### 2.4 设置对话框

- **步骤**：点击"设置"按钮
- **期望**：打开设置对话框，可以配置应用设置
- **验证**：对话框显示、设置项可用

### 2.5 主题切换

- **步骤**：点击主题切换按钮
- **期望**：在亮色/暗色/跟随系统之间切换
- **验证**：主题实时更新、设置持久化

## 3. 左侧栏功能测试 (LeftSidebar)

### 3.1 侧边栏折叠/展开

- **步骤**：点击"收起侧边栏"按钮
- **期望**：侧边栏收起为窄条，按钮图标变为展开图标
- **验证**：宽度变化、图标变化、功能按钮可用

### 3.2 房间设置表单

- **步骤**：

1. 修改过期时间（选择不同选项）
2. 设置房间密码
3. 修改最大查看次数
4. 点击"保存设置"

- **期望**：
- 表单字段可以正常编辑
- 保存成功显示 toast
- 设置立即生效
- 刷新页面后设置保持
- **验证**：表单交互、保存成功、数据持久化

### 3.3 房间权限设置

- **步骤**：

1. 点击权限按钮（预览、编辑、分享、删除）
2. 测试权限依赖：

- 尝试启用编辑但禁用预览（应该自动启用预览）
- 尝试启用删除但禁用预览/编辑（应该自动启用）
- 尝试禁用预览但保留其他权限（应该禁用所有）

3. 点击"保存权限"

- **期望**：
- 权限按钮可以切换状态
- 权限依赖自动处理
- 保存按钮在有变更时启用
- 保存成功后 token 刷新
- slug 根据 SHARE 权限更新
- **验证**：按钮状态、依赖逻辑、token 权限更新、slug 变化

### 3.4 房间分享功能

说明：当房间有分享权限时：允许用户直接通过 http://domain.com/room_name
的方式访问对应的 room 如果不允许的话，那么这个字段的含义就是：不允许用户直接通过
http://domain.com/room_name 的方式访问对应的 room , 用户需要访问的该 SHARE 为
false 的 room 的话，就需要我们通过我们给出的链接来访问对应的 room.
http://domain.com/room_name_[uuid] 也就是 room_name_[uuid], room_name +
随机的一个 uuid 拼接重构构成的新的 room name. 如果该 room_name
存在，那么就需要重新再生成 room_name + uuid 直到唯一 (这个是房间分享功能的逻辑)

- **步骤**：

1. 点击"获取链接"按钮
2. 点击"下载"按钮（下载二维码）
3. 复制分享链接

- **期望**：
- 显示房间链接（根据 SHARE 权限显示名称或 slug）
- 二维码显示
- 可以复制链接
- 可以下载二维码
- **验证**：链接格式、二维码显示、复制功能

### 3.5 容量使用显示

- **步骤**：上传不同大小的文件
- **期望**：容量使用实时更新，显示百分比和已用/总量
- **验证**：数值准确、格式正确、实时更新

## 4. 中间栏功能测试 (MiddleColumn)

在本系统中，消息在 rust server 后端中表现为特殊的 room content: Text.
而在前端，这应该将该 text 类型的 content 展示为消息，而不是文件。

### 4.1 消息发送功能

- **步骤**：

1. 在消息输入框输入内容
2. 按 Enter 发送
3. 按 Shift+Enter 换行
4. 使用 Markdown 格式（粗体、代码块等）
5. 点击"发送"按钮

- **期望**：
- 消息立即显示在列表中（乐观更新）
- Markdown 渲染正确
- 发送按钮在输入为空时禁用
- 显示时间戳
- **验证**：消息显示、格式渲染、按钮状态、时间显示

### 4.2 消息编辑功能

- **步骤**：

1. 点击已有消息
2. 编辑内容
3. 保存或取消

- **期望**：
- 进入编辑模式
- 可以修改内容
- 保存后更新消息
- 取消后恢复原内容
- **验证**：编辑模式、保存更新、取消恢复

### 4.3 消息删除功能

- **步骤**：

1. 选择消息
2. 删除消息（通过右键菜单或其他方式）

- **期望**：
- 消息从列表中移除
- 显示删除成功提示
- **验证**：消息移除、提示显示

### 4.4 消息选择功能

- **步骤**：

1. 点击消息 checkbox 选择
2. 点击"全选"
3. 点击"反选"
4. 点击"取消全选"

- **期望**：
- 单个消息可以选择/取消
- 全选选择所有消息
- 反选反转选择状态
- 顶部栏按钮根据选择状态启用/禁用
- **验证**：选择状态、按钮联动、批量操作可用

### 4.5 权限控制（只读模式）

- **步骤**：

1. 设置房间权限为只读（只有预览权限）
2. 刷新页面
3. 尝试发送消息

- **期望**：
- 消息输入框不显示或被禁用
- 显示提示信息（如需权限提示）
- **验证**：UI 隐藏/禁用、提示信息

## 5. 右侧栏功能测试 (RightSidebar)

目前的文件 item 存在 文件名称过长，而导致的内容溢出，或者水平位置不对。
需要解决该问题。推荐使用 wrap, 将文字 wrap 为多行。

### 5.1 文件上传功能

- **步骤**：

1. 点击"上传文件"按钮或拖拽文件
2. 选择单个文件上传
3. 选择多个文件上传
4. 上传大文件
5. 上传不同格式文件（图片、PDF、文本等）

- **期望**：
- 文件选择对话框打开
- 上传进度显示
- 上传成功后在文件列表中显示
- 显示文件大小、名称
- 容量使用更新
- **验证**：上传进度、列表更新、文件信息、容量更新

### 5.2 文件下载功能

- **步骤**：

1. 点击单个文件下载
2. 选择多个文件后点击"下载选中文件"

- **期望**：
- 单个文件直接下载
- 多个文件打包下载
- 下载文件内容正确
- **验证**：下载触发、文件内容、打包格式

### 5.3 文件删除功能

- **步骤**：

1. 选择文件
2. 点击"删除文件"按钮
3. 确认删除（如果有对话框）

- **期望**：
- 文件从列表中移除
- 容量使用减少
- 显示删除成功提示
- **验证**：文件移除、容量更新、提示显示

### 5.4 文件预览功能

- **步骤**：

1. 点击文件卡片
2. 在不同文件类型上测试（图片、PDF、文本）

- **期望**：
- 打开预览模态框
- 正确显示文件内容
- 可以关闭预览
- **验证**：模态框显示、内容渲染、关闭功能

### 5.5 文件选择功能

- **步骤**：

1. 点击文件 checkbox
2. 点击"全选"
3. 点击"反选"

- **期望**：
- 单个文件可以选择
- 全选选择所有文件
- 反选反转选择状态
- 批量操作按钮根据选择状态启用
- **验证**：选择状态、按钮状态、批量操作

### 5.6 权限控制（只读模式）

- **步骤**：

1. 设置权限为只读
2. 刷新页面
3. 尝试上传文件

- **期望**：
- 文件上传区域不显示或被禁用
- 可以查看和下载文件
- **验证**：上传区域隐藏、查看功能可用

## 6. 实时更新测试

### 6.1 消息自动刷新

- **步骤**：

1. 在一个浏览器标签页发送消息
2. 在另一个标签页观察

- **期望**：第二个标签页自动更新消息列表（每 5 秒）
- **验证**：自动刷新、数据同步

### 6.2 文件自动刷新

- **步骤**：

1. 在一个标签页上传文件
2. 在另一个标签页观察

- **期望**：文件列表自动更新
- **验证**：自动刷新、列表同步

## 7. 错误处理测试

### 7.1 网络错误处理

- **步骤**：模拟网络断开或服务器错误
- **期望**：显示友好的错误提示，不影响其他功能
- **验证**：错误提示、错误恢复

### 7.2 权限错误处理

- **步骤**：尝试执行无权限的操作
- **期望**：显示权限不足提示
- **验证**：错误提示、操作阻止

### 7.3 Token 过期处理

- **步骤**：等待 token 过期或手动清除 token
- **期望**：自动刷新 token 或重新获取
- **验证**：token 刷新、请求重试

## 8. 边界情况测试

### 8.1 超长文件名

- **步骤**：上传超长文件名的文件
- **期望**：文件名在 UI 中正确截断，不破坏布局
- **验证**：文件名显示、布局保持

### 8.2 空消息/空文件

- **步骤**：发送空消息或上传空文件
- **期望**：验证阻止或显示提示
- **验证**：输入验证、错误提示

### 8.3 大量数据

- **步骤**：发送大量消息，上传大量文件
- **期望**：列表性能良好，滚动流畅
- **验证**：性能、滚动体验

## 测试执行顺序

1. **基础流程**：房间创建 → 权限设置 → 消息发送 → 文件上传
2. **权限控制**：测试不同权限组合下的功能可用性
3. **高级功能**：消息编辑、文件预览、批量操作
4. **边界情况**：错误处理、异常输入
5. **实时同步**：多标签页数据同步
6. **UI 交互**：折叠展开、主题切换、设置配置

## 验证检查清单

每个测试完成后检查：

- [ ] 功能按预期工作
- [ ] UI 反馈正确（toast、错误提示等）
- [ ] 数据同步正确（前端状态与后端一致）
- [ ] 权限控制正确（基于 JWT 权限）
- [ ] 错误处理友好
- [ ] 性能表现良好
- [ ] 代码中无冗余日志（保留必要的 error 日志）
