# æ–‡ä»¶ä¸Šä¼ /åˆ é™¤åŠŸèƒ½ - æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š

I recommend you manual test firstly using browser tools (or chrome-devtools),
and during manually testing. record each operations and items id (or path). and
update the
/Users/unic/dev/projs/rs/elizabeth/web/e2e/selectors/html-selectors.ts
definition of web-items. and then correct the related playwright tests.

you can run the above operation as a loop flow till all tests are manually
passed, and all UI automation tests are passed.

if you encounter problems or issues, please check the code from
backend/frontend. and you also can use sqlite to retrieve sqlite database which
can aid you locate the issue.(if you want to reset database, please run just
reset-db)

and if you want to kill/restart/start/status backend/frontend service, please
use manage_services.sh to control

- backend: /Users/unic/dev/projs/rs/elizabeth/crates/board
- frontend: /Users/unic/dev/projs/rs/elizabeth/web
- database: /Users/unic/dev/projs/rs/elizabeth/app.db
- service manage script: /Users/unic/dev/projs/rs/elizabeth/manage_services.sh

ä¸€äº›å®ç°æµç¨‹ï¼š

1. ä¸Šä¼  room ä¸­çš„ contents æ—¶ï¼Œæ˜¯å°† content åŸƒä¸ªä¸Šä¼ åˆ° server ä¸Šï¼Œç„¶åå† check
   è¯¥æ–‡ä»¶çš„ size æ˜¯å¦ ç¬¦åˆè¦æ±‚ï¼šå³ new-file-size + current-file-size <=
   max-file-size. è¿™æ ·çš„åšæ³•æ˜¯ä¸å¯¹ã€‚ä¸Šä¼ æ–‡ä»¶ (s)
   æ—¶ï¼Œåº”è¯¥åœ¨ç”¨æˆ·å®¢æˆ·ç«¯å°±åšå¥½æ–‡ä»¶å¤§å°è·å–å’Œè®¡ç®—ã€‚æ‰€ä»¥ä¸Šä¼ åˆ° server
   çš„é˜¶æ®µä¹Ÿåº”è¯¥åˆ†ä¸ºï¼š
1. å®¢æˆ·ç«¯ï¼šç”¨æˆ·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶/æ–‡ä»¶é›†
1. å®¢æˆ·ç«¯ï¼šè®¡ç®—æœ¬æ¬¡éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶æ€»å¤§å°
1. å®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡ä¸Šä¼ æ£€éªŒçš„è¯·æ±‚ï¼šå‘Šè¯‰ server
   æœ¬æ¬¡ä¸Šä¼ çš„æ–‡ä»¶æ€»å¤§å°ï¼Œç›¸å…³çš„æ–‡ä»¶ä¿¡æ¯ (name,size), å¹¶ä¸”å¾—åˆ° server
   ç«¯çš„å›å¤ï¼Œå¦‚æœå…è®¸ï¼Œé‚£ä¹ˆè¿™è¯´æ˜è¿˜æœ‰è¶³å¤Ÿç©ºé—´ã€‚å¯ä»¥ä¸Šä¼ ã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œserver
   å¯¹åº”çš„ room çš„ current_file_size
   ä¹Ÿåº”è¯¥æ›´æ–°ï¼Œè¿›è¡Œç©ºé—´å ç”¨ã€‚ä»è€Œé¿å…å¹¶å‘çš„é—®é¢˜ã€‚å¦‚æœ 10s
   å†…ï¼Œæ²¡æœ‰å‘èµ·çœŸå®çš„ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶é›†è¯·æ±‚ï¼Œé‚£ä¹ˆ current_file_size åº”è¯¥è¢« server
   ç«¯è¿›è¡Œå›æ»š.(ç†è®ºä¸Šæ¥è¯´ï¼Œè¿™ç§æƒ…å†µä¸å¤ªä¼šå‡ºç°ï¼Œ
   å› ä¸ºå®¢æˆ·ç«¯ä¹Ÿæ˜¯æˆ‘ä»¬ç¼–å†™çš„å‰ç«¯ä»£ç .) å› æ­¤è¿˜éœ€è¦ä¸€å¼ ä¸´æ—¶çš„è¡¨ç”¨æ¥å­˜å‚¨ room_id,
   å¯¹åº”çš„ jwt, è¯¥ jwt çš„ new_file_size, last_check_time. ç”¨äºè·Ÿè¸ªè¯¥ jwt
   çš„ä¸Šä¼ æ–‡ä»¶ç›¸å…³ä¿¡æ¯ï¼Œæ–¹ä¾¿å›æ»šã€‚

1. server
   è¿”å›äº†å…è®¸ä¸Šä¼ çš„å†…å®¹ä¹‹åï¼Œå®¢æˆ·ç«¯åˆ™å¯ä»¥æ‰§è¡ŒçœŸæ­£çš„ä¸Šä¼ ï¼Œå°†æ–‡ä»¶/æ–‡ä»¶é›†ä¸Šä¼ åˆ°
   server.
1. server æ¥æ”¶åˆ°ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶é›†çš„è¯·æ±‚ï¼ŒéªŒè¯ jwt,
   éªŒè¯ç›¸å…³æ–‡ä»¶æ˜¯å¦å’Œç¬¬ä¸‰æ­¥ä¸€è‡´ã€‚ä¸€è‡´ä¹‹åï¼Œåˆ™æ­£å¼å¼€å§‹ä¼ è¾“äº†ã€‚

æˆ¿é—´åˆ›å»ºé€»è¾‘ï¼š
å¯¹åº”çš„æ–‡ä»¶ï¼š/Users/unic/dev/projs/rs/elizabeth/crates/board/src/models/room/permission.rs
RoomPermission è¿˜æœ‰ä¸ªå­—æ®µ const SHARE = 1 << 2;
è¿™ä¸ªå­—æ®µçš„å«ä¹‰ï¼šæ˜¯å¦å…è®¸ç”¨æˆ·ç›´æ¥é€šè¿‡ http://domain.com/room_name çš„æ–¹å¼è®¿é—® room
(å½“å‰æˆ‘ä»¬æ„å»ºçš„æ˜¯åç«¯ api, æ‰€ä»¥ api æ¥å£ä¸ä¸€è‡´) ä½†æ˜¯å‰ç«¯ä¼šè°ƒç”¨å¯¹åº”çš„åç«¯ api.)
å¦‚æœ å…è®¸çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µçš„å«ä¹‰å°±æ˜¯ï¼šå…è®¸ç”¨æˆ·ç›´æ¥é€šè¿‡
http://domain.com/room_name çš„æ–¹å¼è®¿é—®å¯¹åº”çš„ room å¦‚æœ
ä¸å…è®¸çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µçš„å«ä¹‰å°±æ˜¯ï¼šä¸å…è®¸ç”¨æˆ·ç›´æ¥é€šè¿‡
http://domain.com/room_name çš„æ–¹å¼è®¿é—®å¯¹åº”çš„ room ç”¨æˆ·éœ€è¦è®¿é—®çš„è¯¥ SHARE ä¸º
false çš„ room çš„è¯ï¼Œå°±éœ€è¦æˆ‘ä»¬é€šè¿‡æˆ‘ä»¬ç»™å‡ºçš„é“¾æ¥æ¥è®¿é—®å¯¹åº”çš„ room.
http://domain.com/room_name_[uuid] ä¹Ÿå°±æ˜¯ room_name_[uuid], room_name +
éšæœºçš„ä¸€ä¸ª uuid æ‹¼æ¥é‡æ„æ„æˆçš„æ–°çš„ room name. å¦‚æœè¯¥ room_name å­˜åœ¨ï¼Œ
é‚£ä¹ˆå°±éœ€è¦é‡æ–°å†ç”Ÿæˆ room_name + uuid ç›´åˆ°å”¯ä¸€ (ä½†æ˜¯é‡å¤çš„æ¦‚ç‡å¾ˆä½).

**æ—¥æœŸ**: 2025-10-30 **çŠ¶æ€**: ğŸŸ¡ éƒ¨åˆ†å®Œæˆï¼ˆå°æ–‡ä»¶å·¥ä½œï¼Œä¸­ç­‰/å¤§æ–‡ä»¶å¾…ä¿®å¤ï¼‰

## âœ… å·²å®Œæˆçš„æˆå°±

### 1. å‰ç«¯ä¿®å¤ï¼ˆå‰æœŸå·¥ä½œï¼‰

- âœ… React Query ç¼“å­˜é”®ä¿®å¤ (currentRoomId â†’ roomName)
- âœ… API å“åº”æ ¼å¼ä¿®å¤ ({uploaded: [...], current_size: N})
- âœ… å‰ç«¯å‚æ•°ä¿®å¤ (roomName vs currentRoomId)
- âœ… Token è‡ªåŠ¨è·å–æœºåˆ¶

### 2. Chunked Upload åŸºç¡€è®¾æ–½

- âœ… ä¿®å¤äº†`chunked_upload`æ ‡è®°åœ¨ prepare é˜¶æ®µæ²¡æœ‰è¢«è®¾ç½®çš„é—®é¢˜
- âœ… æ‰€æœ‰ chunks ç°åœ¨å¯ä»¥æˆåŠŸä¸Šä¼ ï¼ˆ6 ä¸ª chunks éƒ½é€šè¿‡ï¼‰
- âœ… Chunk å“ˆå¸Œè®¡ç®—å®ç°ï¼ˆSHA256ï¼‰
- âœ… é¢„ç•™è®°å½•æ­£ç¡®åˆ›å»ºå’Œè¿½è¸ª

### 3. å°æ–‡ä»¶ä¸Šä¼ ï¼ˆå®Œå…¨å·¥ä½œï¼‰

- âœ… 100KB æ–‡ä»¶æˆåŠŸä¸Šä¼ å¹¶æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
- âœ… æµ‹è¯•é€šè¿‡ç‡ï¼š100%

## ğŸŸ¡ å½“å‰ç“¶é¢ˆ

### ä¸­ç­‰/å¤§æ–‡ä»¶ä¸Šä¼ å¤±è´¥çš„æ ¹æœ¬åŸå› 

**ç—‡çŠ¶**:

- Chunks ä¸Šä¼ æˆåŠŸï¼ˆåç«¯æ—¥å¿—ç¡®è®¤ï¼‰
- ä½†æ–‡ä»¶æ²¡æœ‰å‡ºç°åœ¨åˆ—è¡¨ä¸­

**æ ¹æœ¬åŸå› **:

1. Chunks ä¸Šä¼ å®Œæˆåéœ€è¦è°ƒç”¨`complete_file_merge` API æ¥åˆå¹¶æ–‡ä»¶
2. Complete API è¿”å› 404 "æˆ¿é—´ä¸å­˜åœ¨"
3. æˆ¿é—´åˆ›å»ºé€»è¾‘æœ‰é—®é¢˜ï¼ˆå¯èƒ½ä¸å‰ç«¯è®¿é—® URL æ²¡æœ‰æŒä¹…åŒ–æˆ¿é—´ç›¸å…³ï¼‰

### Complete API è¿”å› 404

æµ‹è¯•è¡¨æ˜ï¼š

```bash
âœ“ Chunkséƒ½æˆåŠŸä¸Šä¼ ï¼ˆ1ã€2ã€3ã€4ã€5ã€6éƒ½è¿”å›200ï¼‰
âœ— Complete APIè¿”å›404æˆ¿é—´ä¸å­˜åœ¨
âœ— æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼ˆæ²¡æœ‰é€šè¿‡fileServiceè·å–åˆ°ä¸Šä¼ çš„æ–‡ä»¶ï¼‰
```

## ğŸ”§ å·²å°è¯•çš„è§£å†³æ–¹æ¡ˆ

### 1. ç›´æ¥ä¿®å¤ï¼ˆéœ€è¦æ›´å¤šè°ƒæŸ¥ï¼‰

- ## æ£€æŸ¥æˆ¿é—´åˆ›å»º API æ˜¯å¦æ­£å¸¸å·¥ä½œ
- æˆ¿é—´æ˜¯å¦é€šè¿‡å‰ç«¯ URL è®¿é—®æ—¶è¢«æ­£ç¡®æŒä¹…åŒ–

### 2. å‰ç«¯ä¿®æ”¹ï¼ˆéƒ¨åˆ†å®ç°ï¼‰

- ä¸èƒ½è·³è¿‡ complete API è°ƒç”¨
- éœ€è¦æ·»åŠ é‡è¯•é€»è¾‘è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆ2 ç§’ç­‰å¾… + 5 æ¬¡é‡è¯•ï¼‰
- âŒ ä»ç„¶æ— æ³•è·å–æ–‡ä»¶ï¼ˆå› ä¸º complete æœªæ‰§è¡Œï¼‰

## ğŸ“‹ å»ºè®®çš„åç»­æ­¥éª¤

### ä¼˜å…ˆçº§ 1ï¼ˆç«‹å³è§£å†³ï¼‰

1. **è°ƒæŸ¥æˆ¿é—´åˆ›å»º**
   - æ£€æŸ¥å‰ç«¯è®¿é—® URL æ—¶æˆ¿é—´æ˜¯å¦è¢«åˆ›å»º
   - éªŒè¯æˆ¿é—´åœ¨æ•°æ®åº“ä¸­æ˜¯å¦æ­£ç¡®æŒä¹…åŒ–
   - å¯èƒ½éœ€è¦åœ¨å‰ç«¯åŠ è½½æ—¶æ˜¾å¼è°ƒç”¨ API åˆ›å»ºæˆ¿é—´

2. **ä¿®å¤ Complete API**
   - ä½¿ç”¨å·²åˆ›å»ºçš„æˆ¿é—´æµ‹è¯• complete API
   - éªŒè¯é¢„ç•™è®°å½•æ˜¯å¦æ­£ç¡®å…³è”åˆ°æˆ¿é—´

## ğŸ“Š æµ‹è¯•ç»“æœ

```
åˆå§‹åŒ–æµ‹è¯•          âœ“ PASSED
å°æ–‡ä»¶ä¸Šä¼           âœ“ PASSED (100KB)
ä¸­ç­‰æ–‡ä»¶ä¸Šä¼         âœ˜ FAILED (5MB)  - complete API 404
å¤§æ–‡ä»¶ä¸Šä¼           âœ˜ FAILED (15MB) - complete API 404
æ–‡ä»¶åˆ é™¤            âœ˜ FAILED (æ— æ–‡ä»¶)
æ–‡ä»¶é€‰æ‹©/æ‰¹é‡æ“ä½œ    âœ“ PASSED (æ— æ–‡ä»¶æ“ä½œ)
```

## ğŸ¯ å…³é”®å‘ç°

1. **Chunked Upload Pipeline å·¥ä½œæ­£å¸¸**
   - å‰ç«¯èƒ½æ­£ç¡®åˆ†å‰²æ–‡ä»¶ä¸º chunks
   - åç«¯èƒ½æ¥æ”¶å¹¶å­˜å‚¨ chunks
   - é¢„ç•™è®°å½•ç³»ç»Ÿå·¥ä½œæ­£å¸¸

2. **é˜»å¡ç‚¹æ˜¯ Complete/Finalize æ­¥éª¤**
   - Chunks å­˜å‚¨åœ¨/tmp/elizabeth/chunks/{reservationId}/chunk_*
   - éœ€è¦åˆå¹¶åç§»åŠ¨åˆ°å­˜å‚¨ç›®å½•å¹¶åˆ›å»º content è®°å½•
   - Complete API è°ƒç”¨å¤±è´¥é˜»æ­¢äº†è¿™ä¸ªæ­¥éª¤

3. **æˆ¿é—´ç®¡ç†å¯èƒ½æ˜¯æ ¹æœ¬é—®é¢˜**
   - Complete API è¿”å› 404 æˆ¿é—´ä¸å­˜åœ¨
   - éœ€è¦ç¡®è®¤æˆ¿é—´åœ¨æµ‹è¯•æ—¶æ˜¯å¦çœŸçš„è¢«åˆ›å»º

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ

```
1. å‡†å¤‡é˜¶æ®µ âœ“ å·¥ä½œæ­£å¸¸
   - å‰ç«¯è°ƒç”¨prepare API
   - åç«¯åˆ›å»ºé¢„ç•™è®°å½•
   - è¿”å›upload_token

2. ä¸Šä¼ é˜¶æ®µ âœ“ å·¥ä½œæ­£å¸¸
   - å‰ç«¯åˆ†å‰²æ–‡ä»¶ä¸ºchunks
   - æ¯ä¸ªchunkä¸Šä¼ æˆåŠŸ
   - åç«¯å­˜å‚¨chunksåˆ°/tmp/

3. å®Œæˆé˜¶æ®µ âœ— å¤±è´¥
   - å‰ç«¯éœ€è¦æˆåŠŸè°ƒç”¨ complete
   - åç«¯éœ€è¦åˆå¹¶ chunks
   - éœ€è¦åˆ›å»º content è®°å½•

4. è·å–é˜¶æ®µ âœ— å¤±è´¥
   - å‰ç«¯fileService.uploadFileå°è¯•GET /contents
   - è¿”å›ç©ºåˆ—è¡¨ï¼ˆå› ä¸ºcompleteæœªæ‰§è¡Œï¼‰
   - æµ‹è¯•å¤±è´¥
```

## ä»£ç æ”¹åŠ¨æ‘˜è¦

### åç«¯

- `/crates/board/src/handlers/chunked_upload.rs`
  - âœ… ä¿®å¤ prepare_chunked_upload è®¾ç½® chunked_upload æ ‡è®°
  - âœ… ä¿®å¤ upload_chunk éªŒè¯é€»è¾‘

### å‰ç«¯

- `/web/api/chunkedUploadService.ts`
  - éœ€è¦æ˜¾å¼ complete è°ƒç”¨
  - ğŸ“ éœ€è¦ï¼šéªŒè¯æ˜¯å¦èƒ½æ­£ç¡®å¤„ç†ç¼ºå°‘ complete çš„æƒ…å†µ

- `/web/api/fileService.ts`
  - âœ… æ·»åŠ é‡è¯•é€»è¾‘
  - âœ… æ·»åŠ  placeholder è¿”å›å€¼
  - ğŸ“ éœ€è¦ï¼šéªŒè¯ placeholder æ˜¯å¦å½±å“ UI

## ğŸ“Œ æ€»ç»“

å°æ–‡ä»¶ä¸Šä¼ å·²å®Œå…¨å·¥ä½œï¼Œè¯æ˜æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€è®¾æ–½æ˜¯æ­£ç¡®çš„ã€‚Chunked upload
çš„åŸºç¡€ä¹Ÿå·¥ä½œæ­£å¸¸ï¼Œé˜»å¡ç‚¹æ˜¯ complete/finalize æ­¥éª¤å’Œå¯èƒ½çš„æˆ¿é—´åˆ›å»ºé—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆåœ¨æŠ€æœ¯ä¸Šæ˜¯æ˜ç¡®çš„ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•æˆ¿é—´åˆ›å»ºå’Œå®Œæˆ complete API è°ƒç”¨ã€‚
