# ä¿®å¤å’Œæ”¹è¿› - 2025-11-02

## ğŸ“‹ ä¿®å¤çš„é—®é¢˜

### 1. âœ… å¯†ç åˆ é™¤ BUG ä¿®å¤

#### é—®é¢˜æè¿°

å½“ç”¨æˆ·åˆ é™¤æˆ¿é—´å¯†ç ï¼ˆæ¸…ç©ºå¯†ç è¾“å…¥æ¡†ï¼‰å¹¶ä¿å­˜è®¾ç½®æ—¶ï¼Œå‰ç«¯æç¤º"ä¿å­˜æˆåŠŸ"ï¼Œä½†å®é™…æ•°æ®åº“ä¸­å¯†ç å¹¶æœªè¢«æ¸…ç©ºã€‚åˆ·æ–°é¡µé¢åä»éœ€è¦è¾“å…¥å¯†ç ã€‚

#### æ ¹æœ¬åŸå› 

å‰ç«¯å°†ç©ºå¯†ç è½¬æ¢ä¸º `null`ï¼Œä½†åç«¯æœŸæœ›æ¥æ”¶ç©ºå­—ç¬¦ä¸² `""` æ¥æ¸…ç©ºå¯†ç ã€‚

#### è§£å†³æ–¹æ¡ˆ

**å‰ç«¯ä¿®æ”¹** (`web/components/room/room-settings-form.tsx`):

```typescript
// âœ… FIX: Send empty string "" to clear password, not null
const newPassword = password.trim();
const oldPassword = roomDetails.password || "";
const passwordChanged = newPassword !== oldPassword;

updateMutation.mutate({
  expiresAt: expiresAt ?? undefined,
  password: newPassword, // Send empty string to clear password
  maxViews,
  passwordChanged,
});
```

**API å±‚ä¿®æ”¹** (`web/api/roomService.ts`):

```typescript
if (settings.password !== undefined) {
  // âœ… FIX: Send empty string to clear password, backend expects empty string not null
  payload.password = settings.password === null ? "" : settings.password;
}
```

**åç«¯é€»è¾‘** (`crates/board/src/handlers/rooms.rs` ç¬¬ 722-728 è¡Œ):

```rust
// æ›´æ–°å­—æ®µ
if let Some(password) = payload.password {
    room.password = if password.is_empty() {
        None  // âœ… Empty string clears password
    } else {
        Some(password)
    };
}
```

#### æµ‹è¯•æ­¥éª¤

1. åˆ›å»ºä¸€ä¸ªå¸¦å¯†ç çš„æˆ¿é—´ï¼ˆå¦‚ `test123`ï¼‰
2. è¿›å…¥æˆ¿é—´è®¾ç½®
3. æ¸…ç©ºå¯†ç è¾“å…¥æ¡†
4. ç‚¹å‡»"ä¿å­˜è®¾ç½®"
5. éªŒè¯ï¼š
   - âœ… æç¤º"è®¾ç½®å·²ä¿å­˜"
   - âœ… æ•°æ®åº“ä¸­ `password` å­—æ®µä¸º `NULL`
   - âœ… åˆ·æ–°é¡µé¢åæ— éœ€è¾“å…¥å¯†ç 

---

### 2. âœ… å…¨å±åŠŸèƒ½æ‰©å±•åˆ°æ‰€æœ‰æ–‡ä»¶ç±»å‹

#### é—®é¢˜æè¿°

å…¨å±æŸ¥çœ‹æŒ‰é’®åªåœ¨æ–‡æœ¬æ–‡ä»¶é¢„è§ˆæ—¶å¯ç”¨ï¼Œå›¾ç‰‡ã€è§†é¢‘ã€PDF ç­‰å…¶ä»–ç±»å‹æ— æ³•å…¨å±æŸ¥çœ‹ã€‚

#### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**: `web/components/files/file-preview-modal.tsx`

åœ¨å·¥å…·æ æ·»åŠ å…¨å±æŒ‰é’®ï¼ˆé€‚ç”¨äºæ‰€æœ‰æ–‡ä»¶ç±»å‹ï¼‰:

```typescript
<Button
  variant="outline"
  size="sm"
  onClick={() => setIsFullscreen(!isFullscreen)}
  title={isFullscreen ? "é€€å‡ºå…¨å±" : "å…¨å±æŸ¥çœ‹"}
>
  <Maximize2 className="h-4 w-4 mr-2" />
  {isFullscreen ? "é€€å‡ºå…¨å±" : "å…¨å±"}
</Button>;
```

å…¨å±æ ·å¼ï¼ˆä½¿ç”¨ `!important` è¦†ç›–é»˜è®¤æ ·å¼ï¼‰:

```typescript
<DialogContent
  className={`${
    isFullscreen
      ? "!max-w-[98vw] !w-[98vw] !max-h-[98vh] !h-[98vh]"
      : "max-w-4xl max-h-[90vh]"
  } flex flex-col transition-all duration-300`}
>
```

#### æµ‹è¯•æ­¥éª¤

1. ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
2. ç‚¹å‡»é¢„è§ˆ
3. ç‚¹å‡»å·¥å…·æ çš„"å…¨å±"æŒ‰é’®
4. éªŒè¯ï¼š
   - âœ… Modal æ‰©å±•åˆ° 98vw Ã— 98vh
   - âœ… å›¾ç‰‡å¯ä»¥å®Œæ•´æ˜¾ç¤º
   - âœ… æœ‰å¹³æ»‘è¿‡æ¸¡åŠ¨ç”»
5. ç‚¹å‡»"é€€å‡ºå…¨å±"
6. éªŒè¯ï¼š
   - âœ… æ¢å¤æ­£å¸¸å¤§å°

---

### 3. âœ… è¯­æ³•é«˜äº®åº“è¿ç§»ï¼šPrism.js â†’ Shiki

#### é—®é¢˜æè¿°

ç”¨æˆ·è¦æ±‚ä½¿ç”¨ Shiki æ›¿ä»£ Prism.js ä½œä¸ºä»£ç è¯­æ³•é«˜äº®åº“ã€‚

#### ä¸ºä»€ä¹ˆé€‰æ‹© Shikiï¼Ÿ

- âœ… ä½¿ç”¨ VS Code çš„ TextMate è¯­æ³•å¼•æ“
- âœ… æ”¯æŒ 600+ ç§è¯­è¨€å’Œ 200+ ä¸»é¢˜
- âœ… ç”Ÿæˆçš„ HTML æ›´è½»é‡ï¼ˆæ— éœ€è¿è¡Œæ—¶ JSï¼‰
- âœ… æ›´å‡†ç¡®çš„è¯­æ³•é«˜äº®
- âœ… æ›´å¥½çš„æ€§èƒ½

#### å®ç°æ–¹æ¡ˆ

**1. å®‰è£…ä¾èµ–**:

```bash
pnpm add shiki
pnpm remove react-syntax-highlighter @types/react-syntax-highlighter
```

**2. åˆ›å»º CodeBlock ç»„ä»¶** (`web/components/ui/code-block.tsx`):

```typescript
import { type BundledLanguage, type BundledTheme, codeToHtml } from "shiki";

export function CodeBlock({
  code,
  language,
  theme = "dark",
  showLineNumbers = true,
}: CodeBlockProps) {
  // Async highlight using Shiki
  const highlighted = await codeToHtml(code, {
    lang: normalizedLang as BundledLanguage,
    theme: theme === "dark" ? "vitesse-dark" : "vitesse-light",
    structure: "inline",
  });

  return <div dangerouslySetInnerHTML={{ __html: highlighted }} />;
}
```

**3. æ›´æ–° FileContentPreview**
(`web/components/files/file-content-preview.tsx`):

- ç§»é™¤ `react-syntax-highlighter` å¯¼å…¥
- ä½¿ç”¨ `<CodeBlock>` ç»„ä»¶æ›¿ä»£ `<SyntaxHighlighter>`
- æ”¯æŒ Markdown ä»£ç å—é«˜äº®
- æ”¯æŒä»£ç æ–‡ä»¶é«˜äº®

**4. æ”¯æŒçš„è¯­è¨€**:

- JavaScript, TypeScript, JSX, TSX
- Python, Rust, Java, C++, C, C#, Go
- Ruby, PHP, Swift, Kotlin, Scala, Dart
- Bash, PowerShell, SQL
- JSON, YAML, TOML, XML
- HTML, CSS, SCSS, Less
- Markdown, Dockerfile, Nginx, GraphQL
- ç­‰ 600+ ç§è¯­è¨€

**5. æ”¯æŒçš„ä¸»é¢˜**:

- æš—è‰²ä¸»é¢˜ï¼š`vitesse-dark`
- äº®è‰²ä¸»é¢˜ï¼š`vitesse-light`

#### æµ‹è¯•æ­¥éª¤

1. ä¸Šä¼  `.rs` Rust æ–‡ä»¶
2. ç‚¹å‡»é¢„è§ˆ
3. éªŒè¯ï¼š
   - âœ… è¯­æ³•é«˜äº®æ­£ç¡®ï¼ˆä½¿ç”¨ VS Code é£æ ¼ï¼‰
   - âœ… è¡Œå·æ˜¾ç¤º
   - âœ… ä¸»é¢˜åˆ‡æ¢æ­£å¸¸
4. ä¸Šä¼  `.md` Markdown æ–‡ä»¶ï¼ˆåŒ…å«ä»£ç å—ï¼‰
5. ç‚¹å‡»é¢„è§ˆ
6. éªŒè¯ï¼š
   - âœ… Markdown æ¸²æŸ“æ­£ç¡®
   - âœ… ä»£ç å—ä½¿ç”¨ Shiki é«˜äº®
7. åˆ‡æ¢åˆ°ä»£ç æ¨¡å¼
8. éªŒè¯ï¼š
   - âœ… åŸå§‹ Markdown ä½¿ç”¨ Shiki é«˜äº®

---

### 4. âš ï¸ å›¾ç‰‡é¢„è§ˆé—®é¢˜è°ƒæŸ¥

#### é—®é¢˜æè¿°

å›¾ç‰‡é¢„è§ˆæ—¶æ²¡æœ‰ä»»ä½•æŠ¥é”™ï¼Œä½†å®é™…é¢„è§ˆæ—¶æ²¡æœ‰å›¾ç‰‡æ˜¾ç¤ºã€‚

#### è°ƒè¯•æ”¹è¿›

**æ·»åŠ è¯¦ç»†æ—¥å¿—** (`web/components/files/file-preview-modal.tsx`):

```typescript
<img
  src={imageUrl}
  alt={file.name}
  onLoad={() => {
    console.log("Image loaded successfully:", imageUrl);
  }}
  onError={(e) => {
    console.error("Image load error for URL:", imageUrl);
    console.error("Error event:", e);
  }}
/>;

{
  isImage && !imageUrl && (
    <div className="flex items-center justify-center p-4 text-muted-foreground">
      <p>æ— æ³•ç”Ÿæˆå›¾ç‰‡ URLï¼ˆç¼ºå°‘ token æˆ– URLï¼‰</p>
    </div>
  );
}
```

#### æµ‹è¯•æ­¥éª¤

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆConsole å’Œ Network æ ‡ç­¾ï¼‰
2. ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼š`/Users/unic/Downloads/all/pictures/monad-pixelart.png`
3. ç‚¹å‡»å›¾ç‰‡é¢„è§ˆ
4. æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºï¼š
   - æŸ¥çœ‹ "Generated authenticated URL" æ—¥å¿—
   - æŸ¥çœ‹æ˜¯å¦æœ‰ "Image loaded successfully" æˆ– "Image load error"
5. æ£€æŸ¥ Network æ ‡ç­¾ï¼š
   - æŸ¥çœ‹å›¾ç‰‡è¯·æ±‚çš„ URL
   - æŸ¥çœ‹å“åº”çŠ¶æ€ç ï¼ˆåº”è¯¥æ˜¯ 200ï¼‰
   - æŸ¥çœ‹å“åº”å¤´ï¼ˆContent-Type åº”è¯¥æ˜¯ image/*)
   - æŸ¥çœ‹æ˜¯å¦æœ‰ CORS é”™è¯¯

#### å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

**é—®é¢˜ 1: Token è¿‡æœŸæˆ–æ— æ•ˆ**

- æ£€æŸ¥ localStorage ä¸­çš„ token
- å°è¯•é‡æ–°è¿›å…¥æˆ¿é—´

**é—®é¢˜ 2: URL æ ¼å¼é”™è¯¯**

- æ£€æŸ¥ç”Ÿæˆçš„ URL
  æ ¼å¼ï¼š`http://localhost:4092/api/v1/rooms/{roomName}/contents/{id}?token={token}`
- ç¡®ä¿ `API_BASE_URL` æ­£ç¡®

**é—®é¢˜ 3: CORS é—®é¢˜**

- æ£€æŸ¥åç«¯æ˜¯å¦å…è®¸è·¨åŸŸè¯·æ±‚
- æ£€æŸ¥å“åº”å¤´ä¸­çš„ `Access-Control-Allow-Origin`

**é—®é¢˜ 4: æ–‡ä»¶è·¯å¾„é—®é¢˜**

- æ£€æŸ¥åç«¯æ–‡ä»¶å­˜å‚¨è·¯å¾„
- ç¡®è®¤æ–‡ä»¶ç¡®å®å­˜åœ¨äº `storage/rooms/{room_id}/{filename}`

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆçš„ä¿®å¤

1. âœ… **å¯†ç åˆ é™¤ BUG** - å‰ç«¯å‘é€ç©ºå­—ç¬¦ä¸²ï¼Œåç«¯æ­£ç¡®å¤„ç†
2. âœ… **å…¨å±åŠŸèƒ½** - æ‰©å±•åˆ°æ‰€æœ‰æ–‡ä»¶ç±»å‹ï¼ˆå›¾ç‰‡ã€è§†é¢‘ã€PDF ç­‰ï¼‰
3. âœ… **Shiki è¿ç§»** - ä» Prism.js è¿ç§»åˆ° Shikiï¼Œæ”¯æŒ 600+ è¯­è¨€

### éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•

4. âš ï¸ **å›¾ç‰‡é¢„è§ˆ** - æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼Œéœ€è¦æµè§ˆå™¨æµ‹è¯•ç¡®è®¤é—®é¢˜

### ä¿®æ”¹çš„æ–‡ä»¶

- `web/components/room/room-settings-form.tsx` - å¯†ç åˆ é™¤ä¿®å¤
- `web/api/roomService.ts` - API å±‚å¯†ç å¤„ç†
- `web/components/files/file-preview-modal.tsx` - å…¨å±åŠŸèƒ½ + å›¾ç‰‡è°ƒè¯•
- `web/components/files/file-content-preview.tsx` - Shiki è¿ç§»
- `web/components/ui/code-block.tsx` - æ–°å»º Shiki ç»„ä»¶
- `package.json` - ä¾èµ–æ›´æ–°ï¼ˆæ·»åŠ  shikiï¼Œç§»é™¤ react-syntax-highlighterï¼‰

### ä¾èµ–å˜æ›´

```bash
# æ·»åŠ 
+ shiki@latest

# ç§»é™¤
- react-syntax-highlighter@16.1.0
- @types/react-syntax-highlighter@15.5.13
```

### æ„å»ºçŠ¶æ€

- âœ… TypeScript æ£€æŸ¥é€šè¿‡
- âœ… æ„å»ºæˆåŠŸ
- âœ… å‰ç«¯å·²é‡å¯ (PID: 19578)

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•å›¾ç‰‡é¢„è§ˆ**
   - ä½¿ç”¨æµè§ˆå™¨ä¸Šä¼ æµ‹è¯•å›¾ç‰‡
   - æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
   - ç¡®è®¤é—®é¢˜æ ¹æº

2. **æµ‹è¯•å¯†ç åˆ é™¤**
   - åˆ›å»ºå¸¦å¯†ç çš„æˆ¿é—´
   - åˆ é™¤å¯†ç å¹¶ä¿å­˜
   - éªŒè¯æ•°æ®åº“å’Œå‰ç«¯è¡Œä¸º

3. **æµ‹è¯• Shiki é«˜äº®**
   - ä¸Šä¼ å„ç§è¯­è¨€çš„ä»£ç æ–‡ä»¶
   - éªŒè¯è¯­æ³•é«˜äº®æ­£ç¡®æ€§
   - æµ‹è¯•ä¸»é¢˜åˆ‡æ¢

4. **æµ‹è¯•å…¨å±åŠŸèƒ½**
   - æµ‹è¯•å›¾ç‰‡å…¨å±
   - æµ‹è¯•è§†é¢‘å…¨å±
   - æµ‹è¯• PDF å…¨å±
   - æµ‹è¯•æ–‡æœ¬å…¨å±
