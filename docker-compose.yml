services:
  # ============================================================================
  # Backend Service (Rust + Axum + SQLite)
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: elizabeth-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-4092}:4092"
    volumes:
      # Persist database and storage using bind mounts with proper permissions
      - ./data:/app/data:rw
      - ./storage:/app/storage:rw
      # Mount configuration file template (read-only, but avoid potential conflicts)
      - ./backend.yaml:/app/config/backend.yaml:ro
    environment:
      # Core environment variables - JWT secret for security
      JWT_SECRET: ${JWT_SECRET:-please-change-this-secret-in-production-min-32-chars}
    networks:
      - elizabeth-network
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:4092/api/v1/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 10s

  # ============================================================================
  # Frontend Service (Next.js)
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://elizabeth-backend:4092/api/v1}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
    container_name: elizabeth-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-4001}:4001"
    environment:
      # Runtime environment variables
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://elizabeth-backend:4092/api/v1}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
      NODE_ENV: production
      PORT: 4001
      HOSTNAME: 0.0.0.0
    networks:
      - elizabeth-network
    depends_on:
      - backend
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4001/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s

# ============================================================================
# Networks
# ============================================================================
networks:
  elizabeth-network:
    driver: bridge

# ============================================================================
# Volumes (using bind mounts instead of named volumes)
# ============================================================================
# Local directories ./data and ./storage will be created automatically
