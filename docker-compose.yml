# ============================================================================
# Docker Compose configuration for Elizabeth
# ============================================================================
# File sharing and collaboration platform
# ============================================================================

services:
  # ==========================================================================
  # Backend Service (Rust + Axum)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      extra_hosts:
        - "index.crates.io=${CRATES_IO_INDEX_IPV4:-151.101.89.91}"
        - "static.crates.io=${CRATES_IO_STATIC_IPV4:-151.101.90.137}"
    container_name: elizabeth-backend
    restart: unless-stopped
    volumes:
      # Data persistence
      - ./docker/backend/data:/app/data
      - ./docker/backend/storage:/app/storage
      # Configuration
      - ./docker/backend/config/backend.yaml:/app/config/backend.yaml:ro
    environment:
      # Security
      JWT_SECRET: ${JWT_SECRET:-please-change-this-secret-in-production-min-32-chars}
      # Logging
      RUST_LOG: ${RUST_LOG:-info}
      # Database
      DATABASE_URL: sqlite:/app/data/elizabeth.db
    networks:
      - elizabeth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4092/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Frontend Service (Next.js 16)
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-/api/v1}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
        INTERNAL_API_URL: ${INTERNAL_API_URL:-http://elizabeth-backend:4092/api/v1}
    container_name: elizabeth-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-4001}:4001"
    environment:
      # Public variables (client-side)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-/api/v1}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
      # Internal variables (server-side)
      INTERNAL_API_URL: ${INTERNAL_API_URL:-http://elizabeth-backend:4092/api/v1}
      # Node.js
      NODE_ENV: production
      PORT: 4001
      HOSTNAME: 0.0.0.0
    networks:
      - elizabeth-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s

# ============================================================================
# Networks
# ============================================================================
networks:
  elizabeth-network:
    driver: bridge
