services:
  # ============================================================================
  # Backend Service (Rust + Axum + SQLite)
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: elizabeth-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-4092}:4092"
    volumes:
      # Persist database and storage
      - backend-data:/app/data
      - backend-storage:/app/storage
      # Mount configuration file template (read-only)
      - ./backend.yaml:/config/backend.yaml:ro
    environment:
      # Environment variables that work with the CLI system
      LISTEN_ADDR: 0.0.0.0
      PORT: 4092
      JWT_SECRET: ${JWT_SECRET:-please-change-this-secret-in-production-min-32-chars}
      DATABASE_URL: sqlite:/app/data/app.db
      # Test environment variable override
      CONFIG_FILE: /config/backend.yaml
    networks:
      - elizabeth-network
    healthcheck:
      test: ["CMD", "sqlite3", "/app/data/app.db", "SELECT 1;"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Frontend Service (Next.js)
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://elizabeth-backend:4092/api/v1}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
    container_name: elizabeth-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-4001}:4001"
    environment:
      # Runtime environment variables
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://elizabeth-backend:4092/api/v1}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:4001}
      NODE_ENV: production
      PORT: 4001
      HOSTNAME: 0.0.0.0
    networks:
      - elizabeth-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4001/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s

# ============================================================================
# Networks
# ============================================================================
networks:
  elizabeth-network:
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
volumes:
  backend-data:
    driver: local
  backend-storage:
    driver: local
